---
import { companyName } from '../../content/site';
---

<header
  id="navbar"
  class="fixed top-0 left-0 right-0 z-50 transition-all duration-300"
  style="background-color: rgba(23, 23, 23, 0.85); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);"
  role="banner"
>
  <nav class="container-custom flex items-center justify-between h-12 sm:h-14 !px-2" aria-label="Main navigation">
    <!-- Left: Logo + Company name -->
    <a href="#" class="flex items-center gap-3 group shrink-0" aria-label={`${companyName} — go to top`}>
      <!--
        Logo: public/images/logo/rmi-logo-mark.png (black text on transparent bg).
        The "brightness-0 invert" filter renders it white against the dark navbar.
        If the file is missing, the onerror fallback shows the "RMI" text square.
      -->
      <img
        id="navbar-logo"
        src="/images/logo/rmi-logo-mark.png"
        alt={`${companyName} logo`}
        class="h-12 w-auto brightness-0 invert"
        onload="document.getElementById('navbar-logo-fallback').style.display='none';"
        onerror="this.onerror=null;this.style.display='none';document.getElementById('navbar-logo-fallback').style.display='flex';"
      />
      <!-- Fallback: shown when logo file is missing -->
      <span
        id="navbar-logo-fallback"
        class="items-center justify-center w-9 h-9 rounded bg-accent-500 text-white font-bold text-sm select-none"
        style="display: flex;"
        aria-hidden="true"
      >
        RMI
      </span>
      <span class="hidden sm:inline text-base font-semibold text-white tracking-wide group-hover:text-accent-300 transition-colors">
        {companyName}
      </span>
    </a>

    <!-- Right: Desktop links -->
    <div class="hidden md:flex items-center gap-4 lg:gap-6">
      <a
        href="#services"
        data-nav-section="services"
        class="nav-link text-sm font-medium text-neutral-200 hover:text-white transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent-400 focus-visible:ring-offset-2 focus-visible:ring-offset-transparent rounded px-1 py-1"
      >
        Services
      </a>
      <a
        href="#about"
        data-nav-section="about"
        class="nav-link text-sm font-medium text-neutral-200 hover:text-white transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent-400 focus-visible:ring-offset-2 focus-visible:ring-offset-transparent rounded px-1 py-1"
      >
        About
      </a>
      <a
        href="#contact"
        data-nav-section="contact"
        class="nav-link text-sm font-medium text-neutral-200 hover:text-white transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent-400 focus-visible:ring-offset-2 focus-visible:ring-offset-transparent rounded px-1 py-1"
      >
        Contact
      </a>
      <a
        href="#contact"
        class="btn-primary px-5 py-2 text-sm"
      >
        Request a Quote
      </a>
    </div>

    <!-- Mobile hamburger button -->
    <button
      id="menu-toggle"
      type="button"
      class="md:hidden relative z-10 flex items-center justify-center w-11 h-11 rounded-md text-white hover:bg-white/10 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent-400 focus-visible:ring-offset-2 focus-visible:ring-offset-transparent"
      aria-expanded="false"
      aria-controls="mobile-menu"
      aria-label="Open navigation menu"
    >
      <!-- Hamburger icon (shown when closed) -->
      <svg id="icon-open" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
      </svg>
      <!-- Close icon (shown when open) -->
      <svg id="icon-close" class="w-6 h-6 hidden" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </nav>

</header>

<!-- Mobile menu overlay — outside <header> so backdrop-filter doesn't create a containing block -->
<div
  id="mobile-menu"
  class="md:hidden fixed inset-0 top-12 sm:top-14 z-[60] hidden"
  style="background: rgba(23, 23, 23, 0.97); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);"
  role="dialog"
  aria-modal="true"
  aria-label="Mobile navigation"
>
  <nav class="flex flex-col items-center justify-center gap-8 h-full" aria-label="Mobile navigation links">
    <a href="#services" class="mobile-nav-link text-2xl font-semibold text-neutral-100 hover:text-accent-400 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent-400 rounded px-4 py-2">
      Services
    </a>
    <a href="#about" class="mobile-nav-link text-2xl font-semibold text-neutral-100 hover:text-accent-400 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent-400 rounded px-4 py-2">
      About
    </a>
    <a href="#contact" class="mobile-nav-link text-2xl font-semibold text-neutral-100 hover:text-accent-400 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent-400 rounded px-4 py-2">
      Contact
    </a>
    <a
      href="#contact"
      class="mobile-nav-link mt-4 btn-primary px-8"
    >
      Request a Quote
    </a>
  </nav>
</div>

<style>
  /* Active nav link styling — applied via JS */
  .nav-link-active {
    color: white;
    position: relative;
  }
  .nav-link-active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0.25rem;
    right: 0.25rem;
    height: 2px;
    background: rgb(59, 130, 246); /* accent-500 */
    border-radius: 1px;
  }
</style>

<script>
  // ── Scroll-based background transition ──
  const navbar = document.getElementById('navbar');
  const scrollThreshold = 50;

  function updateNavbar() {
    if (!navbar) return;
    if (window.scrollY > scrollThreshold) {
      navbar.style.backgroundColor = 'rgba(23, 23, 23, 0.95)';
      navbar.style.backdropFilter = 'blur(12px)';
      navbar.style.webkitBackdropFilter = 'blur(12px)';
      navbar.style.boxShadow = '0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1)';
    } else {
      navbar.style.backgroundColor = 'rgba(23, 23, 23, 0.85)';
      navbar.style.backdropFilter = 'blur(8px)';
      navbar.style.webkitBackdropFilter = 'blur(8px)';
      navbar.style.boxShadow = '';
    }
  }

  updateNavbar();
  window.addEventListener('scroll', updateNavbar, { passive: true });

  // ── Mobile menu toggle ──
  const menuToggle = document.getElementById('menu-toggle');
  const mobileMenu = document.getElementById('mobile-menu');
  const iconOpen = document.getElementById('icon-open');
  const iconClose = document.getElementById('icon-close');

  // Focus trap handler — added/removed dynamically when menu opens/closes
  function trapFocus(e: KeyboardEvent) {
    if (!mobileMenu || !menuToggle) return;
    const focusableElements = mobileMenu.querySelectorAll<HTMLElement>('a, button');
    // Include the hamburger button (close button) in the focus cycle
    const allFocusable = [menuToggle, ...Array.from(focusableElements)];
    const firstFocusable = allFocusable[0];
    const lastFocusable = allFocusable[allFocusable.length - 1];

    if (e.key === 'Tab') {
      if (e.shiftKey) {
        if (document.activeElement === firstFocusable) {
          e.preventDefault();
          lastFocusable.focus();
        }
      } else {
        if (document.activeElement === lastFocusable) {
          e.preventDefault();
          firstFocusable.focus();
        }
      }
    }
  }

  function openMenu() {
    if (!mobileMenu || !menuToggle || !iconOpen || !iconClose) return;
    mobileMenu.classList.remove('hidden');
    iconOpen.classList.add('hidden');
    iconClose.classList.remove('hidden');
    menuToggle.setAttribute('aria-expanded', 'true');
    menuToggle.setAttribute('aria-label', 'Close navigation menu');
    document.body.style.overflow = 'hidden';
    // Activate focus trap and move focus to first nav link
    document.addEventListener('keydown', trapFocus);
    const firstLink = mobileMenu.querySelector<HTMLElement>('.mobile-nav-link');
    firstLink?.focus();
  }

  function closeMenu() {
    if (!mobileMenu || !menuToggle || !iconOpen || !iconClose) return;
    mobileMenu.classList.add('hidden');
    iconOpen.classList.remove('hidden');
    iconClose.classList.add('hidden');
    menuToggle.setAttribute('aria-expanded', 'false');
    menuToggle.setAttribute('aria-label', 'Open navigation menu');
    document.body.style.overflow = '';
    // Remove focus trap
    document.removeEventListener('keydown', trapFocus);
  }

  menuToggle?.addEventListener('click', () => {
    const isOpen = menuToggle.getAttribute('aria-expanded') === 'true';
    if (isOpen) {
      closeMenu();
      menuToggle.focus();
    } else {
      openMenu();
    }
  });

  const mobileLinks = mobileMenu?.querySelectorAll('.mobile-nav-link');
  mobileLinks?.forEach((link) => {
    link.addEventListener('click', () => {
      closeMenu();
      menuToggle?.focus();
    });
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && menuToggle?.getAttribute('aria-expanded') === 'true') {
      closeMenu();
      menuToggle.focus();
    }
  });

  // Signal that the menu script is ready (used by Playwright tests)
  menuToggle?.setAttribute('data-ready', 'true');

  // ── Intersection Observer for active nav link highlighting ──
  const navLinks = document.querySelectorAll<HTMLAnchorElement>('a.nav-link[data-nav-section]');
  const mobileNavLinks = document.querySelectorAll<HTMLAnchorElement>('.mobile-nav-link[href^="#"]');
  const sectionIds = ['services', 'about', 'contact'];
  const sections = sectionIds
    .map((id) => document.getElementById(id))
    .filter((el): el is HTMLElement => el !== null);

  // Track intersection ratios per section
  const sectionRatios = new Map<string, number>();
  let currentHash = '';

  function setActiveNav(activeId: string | null) {
    navLinks.forEach((link) => {
      const section = link.getAttribute('data-nav-section');
      if (section === activeId) {
        link.classList.add('nav-link-active');
      } else {
        link.classList.remove('nav-link-active');
      }
    });

    // Update URL hash without creating history entries
    const newHash = activeId ? `#${activeId}` : '';
    if (newHash !== currentHash) {
      currentHash = newHash;
      if (newHash) {
        history.replaceState(null, '', newHash);
      } else {
        // Clear hash — use pathname to avoid the bare '#'
        history.replaceState(null, '', window.location.pathname + window.location.search);
      }
    }
  }

  function updateActiveLink() {
    // Find the first section (in page order) with ≥30% visibility
    let activeId: string | null = null;
    for (const id of sectionIds) {
      if ((sectionRatios.get(id) ?? 0) >= 0.3) {
        activeId = id;
        break;
      }
    }

    // Fallback: if no section hits 30%, pick the one with the highest ratio
    if (!activeId) {
      let best = 0;
      for (const id of sectionIds) {
        const ratio = sectionRatios.get(id) ?? 0;
        if (ratio > best) {
          best = ratio;
          activeId = id;
        }
      }
      // If the best ratio is essentially zero, nothing is active (hero/top)
      if (best < 0.05) activeId = null;
    }

    setActiveNav(activeId);
  }

  if (sections.length > 0) {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          sectionRatios.set(entry.target.id, entry.intersectionRatio);
        });
        updateActiveLink();
      },
      {
        // Offset top by navbar height (h-14 = 56px)
        rootMargin: '-56px 0px 0px 0px',
        threshold: [0, 0.1, 0.2, 0.3, 0.5, 0.7, 1],
      }
    );

    sections.forEach((section) => observer.observe(section));
  }
</script>
